{% extends "randomtest/base.html" %}

{% block title %}
Problem Group: {{prob_group.name}}
{% endblock %}

{% block content %}
<script type="text/javascript">
function togglemarked() {
    var y=document.getElementById("problems");
    lang=y.elements.length;

    check=0;
    for (i=0;i< lang;i++) {
        if (y.elements[i].name == "chk" && y.elements[i].checked==false) {
            check=1;
        }
    }
    if (check==1) {
        for (i=0;i < lang;i++) {
            y.elements[i].checked=true;
        }
    } else {
        for (i=0;i < lang;i++) {
            y.elements[i].checked=false;
        }
    }
}
function fixchecks() {
    var y=document.getElementById("problems");
    lang=y.elements.length;

    allchecked=1;
    allunchecked=1;
    for (i=0;i < lang;i++) {
        if (y.elements[i].name == "chk") {
            if (y.elements[i].checked==false) {
                allchecked=0;
            } else {
                allunchecked=0;
            }
        }
    }
    z=document.getElementById("toggler");
    if (allchecked==1) {
        z.checked=true;
        z.indeterminate=false;
    } else if (allunchecked==1) {
        z.checked=false;
        z.indeterminate=false;
    } else {
	z.indeterminate=true;
    }
}
</script>

<nav aria-label="breadcrumb" role="navigation">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/problemgroups/">My Problem Groups</a></li>
    <li class="breadcrumb-item active" aria-current="page">{{prob_group.name}}</li>
  </ol>
</nav>

<div class="container">
  <h2>Problem Group: {{prob_group.name}}</h2>
  <div class="row">
    <div class="col-lg-9">
      <p>If you remove problems, you must click "Save" for your changes to be saved.</p>
      {% if prob_group.problems.count > 0 %}
      <form action="." method="POST" id="problems">
{% csrf_token %}
	<p><input type="checkbox" id="toggler" onclick="togglemarked()" checked> Select/Deselect All</p>
	<input type="hidden" name="startform" value="{{prob_group.pk}}">
	<div class="list-group mb-3">	  
	  {% for prob in prob_group.problems.all %}
	  <div class="list-group-item">
	    <div class="row">
	      <div class="col-1">
		{{forloop.counter}}.<br>
		<input type="checkbox" name="chk" value="{{prob.label}}" onclick="fixchecks()" checked>
	      </div>
	      <div class="col-10">
		{% if prob.question_type_new.question_type == 'multiple choice' %}
		{% autoescape off %}{{prob.display_mc_problem_text|linebreaks}} {% endautoescape %}  [{{prob.readable_label}}]<br>
		{% else %}
		{% autoescape off %}{{prob.display_problem_text|linebreaks}} {% endautoescape %}  [{{prob.readable_label}}]<br>
		{% endif %}
		
		{% if prob.type_new.type|slice:":2" != "CM" %}(<a href="/problemeditor/contest/bytest/{{prob.type_new.type}}/{{prob.test_label}}/{{prob.label}}/">Edit Tags/Solutions</a>){% endif %}
	      </div>
{% if can_delete %}
	      <div class="col-1" style="text-align:right">
		<span class="fa fa-remove delete-problem-link" style="color:red;cursor:pointer"></span>
	      </div>
{% endif %}
	    </div>
	  </div>
	  {% endfor %}
	</div>
{% if can_delete %}	
	<div id="save-message" class="alert alert-success" style="display:none;" role="alert">Save successful!</div>
	<p><button type="submit" class="btn btn-primary" id="save-prob-group" name="save" value="save">Save</button></p>
{% endif %}
      </form>
      {% else %}
    <p>There are no problems currently in this group. Use the <a href="/search/">Search</a> tab to add problems.</p>
    {% endif %}
    <h2>Create a Test from Selected Problems</h2>
    <form action="." method="POST" id="new-test-form">
{% csrf_token %}
      <p>
	<label for="testname">Name of test:</label>
	<input type="text" name="testname" value="New Test" class="form-control">
      </p>
<div id="error-message" style="display:none">
  <div class="alert alert-danger">
No problems checked!
  </div>
</div>
      <p><button type="submit" class="btn btn-primary" name="newtest" value="newtest">Create Test</button><span class="fa fa-spinner fa-spin fa-3x fa-fw" style="display:none" id="loading"></span></p>
    </form>
</div>
</div>
</div>  


<div id="unsaved-message" style="position:fixed;right:15px;bottom:15px;margin:0;padding:0;display:none;">
  <div class="alert alert-warning">
    You have unsaved changes! Please click "Save" before navigating away.
  </div>
</div>


<script>
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
			    break;
            }
        }
    }
    return cookieValue;
}

var csrftoken = getCookie('csrftoken');

function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}

$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    },
});


$(document).on('click',".delete-problem-link", function(e) {
  $(this).closest('.list-group-item').remove();
  fixchecks();
  $("#save-message").hide();
  $("#unsaved-message").show();
});

$(document).on('submit',"#problems",function(e) {
  e.preventDefault();
  $.ajax({
    type: 'POST',
    url: "/problemgroups/ajax/savegroup/",
    data: $(this).serialize(),
    dataType: 'json',
    success: function(result) {
      $("#unsaved-message").hide();
      $("#save-message").show();
      setTimeout(function() {
        $("#save-message").fadeOut();
      },5000);
    }
  });
  return false;
});

$(document).on('submit',"#new-test-form",function(e) {
  e.preventDefault();
$("#loading").show();
  $.ajax({
    type: 'POST',
    url: "/problemgroups/ajax/create-test/",
    data: $("#problems").serialize()+'&'+$("#new-test-form").serialize(),
    dataType: 'json',
    success: function(result) {
      if ('error-message' in result) {
$("#loading").hide();
        $("#error-message").show();
        setTimeout(function() {
          $("#error-message").fadeOut();
        },5000);
      } else {
        if ('url' in result) {
          window.location.href = result['url'];
        }
      }
    }
  });
  return false;
});
</script>
{% endblock %}
  
